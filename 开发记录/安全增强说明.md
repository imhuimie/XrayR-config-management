# 安全增强说明 (v1.1.0)

## 更新日期
2025-12-07

## 概述

本次更新对项目进行了全面的安全审计和加固，使其能够在生产环境下安全运行。

---

## 新增依赖

```json
{
  "helmet": "^8.1.0",
  "express-rate-limit": "^8.2.1",
  "express-validator": "^7.3.1"
}
```

---

## 安全修复详情

### 1. HTTP 安全头 (Helmet)

**文件**: `server/index.js`

**修复内容**:
- 添加 Helmet 中间件，自动设置多个安全响应头
- 包括 X-Content-Type-Options、X-Frame-Options、X-XSS-Protection 等

**代码示例**:
```javascript
import helmet from 'helmet';

app.use(helmet({
  contentSecurityPolicy: false,
  crossOriginEmbedderPolicy: false
}));
```

### 2. CORS 配置优化

**文件**: `server/index.js`

**修复内容**:
- 支持通过 `CORS_ORIGIN` 环境变量限制允许的来源
- 明确指定允许的 HTTP 方法和请求头

**代码示例**:
```javascript
const corsOptions = {
  origin: process.env.CORS_ORIGIN || true,
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization']
};
app.use(cors(corsOptions));
```

### 3. 请求体大小限制

**文件**: `server/index.js`

**修复内容**:
- 限制 JSON 请求体大小为 1MB，防止 DoS 攻击

**代码示例**:
```javascript
app.use(express.json({ limit: '1mb' }));
app.use(express.urlencoded({ extended: true, limit: '1mb' }));
```

### 4. 全局速率限制

**文件**: `server/index.js`

**修复内容**:
- 每 15 分钟每 IP 最多 1000 次请求
- 防止 DDoS 攻击

**代码示例**:
```javascript
import rateLimit from 'express-rate-limit';

const globalLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 1000,
  message: { error: '请求过于频繁，请稍后再试' }
});
app.use(globalLimiter);
```

### 5. 登录速率限制

**文件**: `server/routes/auth.js`

**修复内容**:
- 每 15 分钟每 IP 最多 5 次登录尝试
- 防止暴力破解攻击
- 成功登录不计入限制

**代码示例**:
```javascript
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5,
  message: { error: '登录尝试次数过多，请 15 分钟后再试' },
  skipSuccessfulRequests: true
});

router.post('/login', loginLimiter, async (req, res) => {
  // ...
});
```

### 6. 登录安全增强

**文件**: `server/routes/auth.js`

**修复内容**:
- 输入类型验证
- 密码长度限制（防止 DoS）
- 登录失败延迟响应（防止时序攻击）

**代码示例**:
```javascript
// 输入验证
if (!password || typeof password !== 'string') {
  return res.status(400).json({ error: '请提供密码' });
}

// 密码长度限制
if (password.length > 128) {
  return res.status(400).json({ error: '密码格式错误' });
}

// 延迟响应
if (!isValid) {
  await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 500));
  return res.status(401).json({ error: '密码错误' });
}
```

### 7. 输入验证模块

**文件**: `server/utils/validator.js` (新增)

**功能**:
- `isValidFilePath()` - 防止路径遍历攻击
- `isValidServerAddress()` - 验证服务器地址格式
- `isValidCommand()` - 检测危险命令模式
- `isValidId()` - 验证 ID 格式
- `isValidUrl()` - 验证 URL 格式
- `isValidLength()` - 验证字符串长度
- `isValidApiKey()` - 验证 API Key 格式
- `escapeHtml()` - 防止 XSS 攻击
- `sanitizeFilePath()` - 清理文件路径

### 8. API 路由输入验证

**修改的文件**:
- `server/routes/panels.js` - 验证面板名称、域名、API Key
- `server/routes/servers.js` - 验证分组 ID、服务器地址、配置路径、部署命令
- `server/routes/batch.js` - 验证服务器 ID、文件路径、命令安全性
- `server/routes/ssh.js` - 验证服务器地址格式
- `server/routes/settings.js` - 增强密码修改验证

### 9. 密码策略增强

**文件**: `server/routes/settings.js`

**修复内容**:
- 最小长度 8 位
- 最大长度 128 位
- 必须包含字母和数字
- bcrypt 成本因子提升到 12

**代码示例**:
```javascript
if (newPassword.length < 8) {
  return res.status(400).json({ error: '新密码长度至少为 8 位' });
}

const hasLetter = /[a-zA-Z]/.test(newPassword);
const hasNumber = /[0-9]/.test(newPassword);
if (!hasLetter || !hasNumber) {
  return res.status(400).json({ error: '新密码必须包含字母和数字' });
}

settings.passwordHash = await bcrypt.hash(newPassword, 12);
```

### 10. 错误信息安全

**修改的文件**: 多个路由文件

**修复内容**:
- 错误日志只记录 `error.message`，不暴露完整堆栈
- 返回给用户的错误信息不包含敏感细节

---

## 环境变量更新

`.env.example` 文件已更新，添加了：

```env
# CORS 允许的来源（生产环境建议设置具体域名）
# 示例：CORS_ORIGIN=https://your-domain.com
# CORS_ORIGIN=
```

---

## 生产环境部署检查清单

### 必须完成

1. **修改 JWT_SECRET**
   ```bash
   # 生成强随机密钥
   node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
   ```

2. **修改管理员密码**
   - 登录后在系统设置中修改
   - 要求：至少 8 位，包含字母和数字

3. **设置 CORS 来源**
   ```env
   CORS_ORIGIN=https://your-domain.com
   ```

### 强烈建议

4. **使用 HTTPS**
   - 配置 Nginx 反向代理
   - 启用 SSL/TLS 证书

5. **配置防火墙**
   - 仅开放必要端口（80, 443）
   - 限制后端端口（61145）仅本地访问

6. **定期备份**
   - 备份 `data/` 目录
   - 建议每日自动备份

---

## Nginx 配置示例

```nginx
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 前端静态文件
    location / {
        root /path/to/client/dist;
        try_files $uri $uri/ /index.html;
    }

    # API 代理
    location /api {
        proxy_pass http://127.0.0.1:61145;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

---

## 文件变更清单

### 新增文件
- `server/utils/validator.js` - 输入验证工具模块

### 修改文件
- `server/index.js` - 添加安全中间件
- `server/routes/auth.js` - 登录速率限制和输入验证
- `server/routes/panels.js` - 输入验证
- `server/routes/servers.js` - 输入验证
- `server/routes/batch.js` - 输入验证
- `server/routes/ssh.js` - 输入验证
- `server/routes/settings.js` - 密码策略增强
- `.env.example` - 添加 CORS_ORIGIN 配置
- `package.json` - 添加安全依赖

---

## 版本信息

- **版本号**: 1.1.0
- **更新类型**: 安全增强
- **向后兼容**: 是
- **需要重新安装依赖**: 是 (`npm install`)

---

**更新者**: Claude Code
**更新日期**: 2025-12-07
