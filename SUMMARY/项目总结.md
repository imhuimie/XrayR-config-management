# XrayR 配置生成器 - 项目总结

## 📋 项目概述

**项目名称**: XrayR 配置生成器
**版本**: 1.0.0
**开发语言**: JavaScript (Node.js + React)
**架构**: 前后端分离
**数据存储**: JSON 文件

---

## 🎯 核心功能

### 1. 用户认证系统
- ✅ JWT Token 认证
- ✅ 密码加密存储 (bcrypt)
- ✅ 登录/登出功能
- ✅ 系统设置中修改密码
- ✅ 密码可见性切换

### 2. 四层数据架构
```
面板 (Panels)
  └── 服务器分组 (Server Groups)
      └── 服务器 (Servers)
          └── 节点 (Nodes)
```

#### 面板管理
- 创建/编辑/删除面板
- 配置面板域名和 API Key
- 支持多面板管理

#### 服务器分组
- 按面板分组管理服务器
- 分组描述和备注

#### 服务器管理
- 服务器基本信息配置
- SSH 连接信息
- 配置文件路径
- 部署后命令

#### 节点管理
- 多种节点类型支持：
  - Shadowsocks
  - V2ray
  - Trojan
- 节点参数配置
- 导入/导出节点配置

### 3. 配置生成功能
- ✅ 自动生成 XrayR 配置文件
- ✅ 支持 YAML 格式
- ✅ 简化配置结构（仅包含必要字段）
- ✅ 配置预览功能
- ✅ 一键复制配置

### 4. SSH 功能
- ✅ SSH 连接测试
- ✅ 配置文件上传
- ✅ 支持密码和私钥认证
- ✅ 代理支持 (HTTP/SOCKS4/SOCKS5)
- ✅ 完善的错误处理

### 5. 批量管理功能
- ✅ 批量上传文件
  - 支持多文件选择
  - 自动创建目录
  - 实时进度显示
- ✅ 批量执行命令
  - 命令输出实时显示
  - 支持多服务器并发
- ✅ 统一的日志输出面板

### 6. 系统设置
- ✅ 修改登录密码
- ✅ SSH 代理配置
  - HTTP 代理
  - SOCKS4 代理
  - SOCKS5 代理
  - 代理认证支持

---

## 🏗️ 技术栈

### 前端
- **框架**: React 18
- **构建工具**: Vite
- **路由**: React Router v6
- **HTTP 客户端**: Axios
- **样式**: CSS3 (CSS 变量 + BEM 命名)
- **状态管理**: 自定义 Hooks

### 后端
- **运行时**: Node.js
- **框架**: Express.js
- **认证**: JWT (jsonwebtoken)
- **密码加密**: bcryptjs
- **SSH 连接**: ssh2
- **代理支持**: socks
- **YAML 处理**: js-yaml
- **安全头**: helmet (v1.1.0 新增)
- **速率限制**: express-rate-limit (v1.1.0 新增)

### 开发工具
- **并发运行**: concurrently
- **环境变量**: dotenv

---

## 📁 项目结构

```
面板管理/
├── client/                 # 前端项目
│   ├── src/
│   │   ├── components/    # React 组件
│   │   │   ├── ListCard.jsx        # 通用列表卡片组件
│   │   │   ├── PanelList.jsx       # 面板列表
│   │   │   ├── ServerGroupList.jsx # 分组列表
│   │   │   ├── ServerList.jsx      # 服务器列表
│   │   │   ├── NodeList.jsx        # 节点列表
│   │   │   ├── ConfigViewer.jsx    # 配置查看器
│   │   │   ├── ImportNodesModal.jsx
│   │   │   ├── NodeModal.jsx
│   │   │   ├── PanelModal.jsx
│   │   │   ├── ServerGroupModal.jsx
│   │   │   ├── ServerModal.jsx
│   │   │   ├── SettingsModal.jsx
│   │   │   ├── SSHModal.jsx
│   │   │   ├── ConfirmDialog.jsx
│   │   │   └── Toast.jsx
│   │   ├── hooks/         # 自定义 Hooks
│   │   │   ├── index.js
│   │   │   ├── useToast.js
│   │   │   ├── useConfirmDialog.js
│   │   │   ├── useCrudModal.js
│   │   │   └── useApiData.js
│   │   ├── pages/         # 页面组件
│   │   │   ├── Dashboard.jsx
│   │   │   ├── Login.jsx
│   │   │   └── BatchManagement.jsx
│   │   ├── styles/        # 样式文件
│   │   │   ├── BatchManagement.css
│   │   │   ├── ConfirmDialog.css
│   │   │   └── Toast.css
│   │   ├── utils/         # 工具函数
│   │   │   └── api.js
│   │   ├── App.jsx
│   │   ├── index.css      # 全局样式（CSS 变量）
│   │   └── main.jsx
│   ├── package.json
│   └── vite.config.js
├── server/                # 后端项目
│   ├── middleware/        # 中间件
│   │   └── auth.js
│   ├── routes/           # 路由
│   │   ├── auth.js
│   │   ├── batch.js
│   │   ├── config.js
│   │   ├── nodes.js
│   │   ├── panels.js
│   │   ├── serverGroups.js
│   │   ├── servers.js
│   │   ├── settings.js
│   │   └── ssh.js
│   ├── utils/            # 工具函数
│   │   ├── dataStore.js      # 数据存储（工厂模式）
│   │   ├── crudFactory.js    # CRUD 路由工厂
│   │   └── validator.js      # 输入验证工具（v1.1.0 新增）
│   └── index.js
├── data/                 # 数据存储
│   ├── nodes.json
│   ├── panels.json
│   ├── serverGroups.json
│   ├── servers.json
│   └── settings.json
├── SUMMARY/              # 项目文档
├── 开发记录/              # 开发文档
├── install.bat           # Windows 安装脚本
├── install.sh            # Linux/Mac 安装脚本
├── install.ps1           # PowerShell 安装脚本
├── start.bat             # 启动脚本
├── CLAUDE.md             # AI 开发指南
├── package.json
└── README.md
```

---

## 🚀 快速开始

### 1. 环境要求
- Node.js 18.0+
- npm 或 yarn

### 2. 安装依赖

**Windows**:
```cmd
install.bat
```

**Linux/Mac**:
```bash
chmod +x install.sh
./install.sh
```

**PowerShell**:
```powershell
.\install.ps1
```

### 3. 启动项目

**方式一：一键启动** (推荐):
```cmd
start.bat
```
- 自动检查并停止占用端口的进程
- 自动检查依赖是否安装
- 同时启动前后端服务

**方式二：使用 npm**:
```cmd
npm run dev
```

**方式三：分别启动**:
```cmd
# 终端1：启动后端
start-server.bat

# 终端2：启动前端
start-client.bat
```

详细说明请查看: [启动脚本说明](启动脚本说明.md)

### 4. 访问系统
- **前端**: http://localhost:61146
- **后端**: http://localhost:61145
- **默认密码**: admin123

---

## 🎨 UI 设计特色

### 现代化设计
- 紫色渐变主题 (#667eea → #764ba2)
- 毛玻璃效果卡片
- 平滑动画过渡
- 响应式布局

### CSS 设计系统
- CSS 变量定义设计令牌
- BEM 命名规范
- 统一的组件样式

### 批量管理页面
- 左右分栏布局
- VS Code 风格的深色日志输出
- 实时进度显示
- 清晰的视觉反馈

### 交互优化
- 密码可见性切换
- 悬停效果
- 加载状态提示
- 错误信息友好显示

---

## 🔧 代码架构优化

### 前端优化

#### 自定义 Hooks
- `useToast` - Toast 通知管理
- `useConfirmDialog` - 确认对话框管理
- `useCrudModal` - CRUD 模态框状态管理
- `useApiData` - API 数据加载

#### 通用组件
- `ListCard` - 统一列表展示组件
- `ActionButton` - 操作按钮组件

#### CSS 设计系统
```css
:root {
  --color-primary: #667eea;
  --color-success: #48bb78;
  --color-danger: #f56565;
  --spacing-md: 12px;
  --radius-md: 8px;
}
```

### 后端优化

#### 工厂模式
- `dataStore.js` - 使用工厂模式创建数据访问器
- `crudFactory.js` - CRUD 路由工厂函数

#### 设计原则
- **DRY**: 消除重复代码
- **KISS**: 保持简单
- **单一职责**: 每个模块只做一件事

---

## 📊 数据流程

### 配置生成流程
```
1. 选择面板
   ↓
2. 选择服务器分组
   ↓
3. 选择服务器
   ↓
4. 选择节点
   ↓
5. 生成配置
   ↓
6. 预览/复制/上传
```

### SSH 上传流程
```
1. 读取系统设置（代理配置）
   ↓
2. 建立 SSH 连接（支持代理）
   ↓
3. 创建目标目录（mkdir -p）
   ↓
4. 上传配置文件
   ↓
5. 执行部署命令（可选）
```

### 批量操作流程
```
1. 选择服务器分组
   ↓
2. 选择多个服务器
   ↓
3. 选择操作类型（上传/命令）
   ↓
4. 遍历服务器执行操作
   ↓
5. 实时显示结果
```

---

## 🔒 安全特性

### HTTP 安全 (v1.1.0 新增)
- Helmet 安全响应头
- CORS 配置（可限制来源）
- 请求体大小限制（1MB）
- 全局速率限制（1000次/15分钟）

### 认证安全
- JWT Token 认证（24小时过期）
- 登录速率限制（5次/15分钟）
- 密码 bcrypt 加密（成本因子 12）
- 登录失败延迟响应（防时序攻击）
- 原密码验证

### 输入验证 (v1.1.0 新增)
- 路径遍历攻击防护
- 命令注入检测
- 服务器地址格式验证
- ID/URL 格式验证
- 字符串长度限制

### 数据安全
- 本地文件存储
- 敏感信息加密
- API 路由保护
- 错误信息不暴露敏感细节

### 连接安全
- SSH 密钥支持
- 代理认证
- 连接超时控制
- 错误隔离

---

## ⚡ 性能优化

### 前端优化
- React 组件懒加载
- 自定义 Hooks 状态管理
- 并行 API 请求
- 防抖/节流处理

### 后端优化
- 异步 I/O
- 连接池复用
- 错误处理优化
- 超时控制

---

## 🐛 错误处理

### 多层错误保护
```
1. 代理连接 try-catch
   ↓
2. Socket 错误处理器
   ↓
3. SSH 连接 try-catch
   ↓
4. SSH 错误事件处理器
   ↓
5. 响应发送前检查
   ↓
6. 全局异常处理器
```

### 用户友好提示
- 详细的错误信息
- 操作指引
- 状态反馈

---

## 📝 配置文件格式

### XrayR 配置示例
```yaml
Log:
  Level: warning

Nodes:
  - PanelType: "V2board"
    ApiConfig:
      ApiHost: "https://example.com"
      ApiKey: "your-api-key"
      NodeID: 1
    ControllerConfig:
      ListenIP: 0.0.0.0
      EnableDNS: false
```

---

## 🔄 版本历史

### v1.1.0 (当前版本 - 安全增强)
- ✅ Helmet HTTP 安全头
- ✅ 速率限制（全局 + 登录）
- ✅ 输入验证模块
- ✅ CORS 配置优化
- ✅ 请求体大小限制
- ✅ 密码策略增强
- ✅ 时序攻击防护

### v1.0.0
- ✅ 完整的四层数据架构
- ✅ 配置生成功能
- ✅ SSH 连接和上传
- ✅ 批量管理功能
- ✅ 系统设置
- ✅ 代理支持
- ✅ 现代化 UI
- ✅ 自定义 Hooks
- ✅ 通用组件
- ✅ CSS 设计系统
- ✅ 代码架构优化

---

## 📞 技术支持

### 常见问题
详见 `SUMMARY/Windows环境要求.md`

### 数据备份
建议定期备份 `data/` 目录

### 端口配置
- 前端端口: 61146 (可在 `client/vite.config.js` 修改)
- 后端端口: 61145 (可在 `.env` 修改)

---

## 🎯 未来规划

### 计划功能
- [ ] 数据库支持 (MySQL/PostgreSQL)
- [ ] 用户权限管理
- [ ] 配置模板系统
- [ ] 批量导入/导出
- [ ] 操作日志记录
- [ ] 定时任务
- [ ] Docker 部署支持

---

## 📄 许可证

MIT License

---

**最后更新**: 2025-12-07
**版本**: 1.1.0 (安全增强版)
